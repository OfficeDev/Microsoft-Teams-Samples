<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Channel lifecycle demo</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://res.cdn.office.net/teams-js/2.34.0/js/MicrosoftTeams.min.js"
            integrity="sha384-brW9AazbKR2dYw2DucGgWCCcmrm2oBFV4HQidyuyZRI/TnAkmOOnTARSTdps3Hwt"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        #mainDiv {
            padding-left: 10%;
            padding-top: 2%;
        }
    </style>
</head>
<body id="mainDiv">
<h4>Channel lifecycle demo</h4>
<br/>

<!-- Action Buttons -->
<button type="button" class="btn btn-outline-success" data-toggle="modal" data-target="#createChannelModal">Create Channel</button>
<button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#updateChannelModal">Update Channel</button>
<button type="button" class="btn btn-outline-info" id="btngetChannel">Get Channel</button>
<button type="button" class="btn btn-outline-danger" onclick="DeleteChannel()">Delete Channel</button>
<br /><br />

<!-- simple popup for create channel -->
<div class="modal fade" id="createChannelModal" tabindex="-1" role="dialog" aria-labelledby="createChannelModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createChannelLabel">Create Channel</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="txtchannelName">Name</label>
                    <input type="text" class="form-control" id="txtchannelName" placeholder="Channel name" required>
                </div>
                <div class="form-group">
                    <label for="txtchannelDesc">Description</label>
                    <input type="text" class="form-control" id="txtchannelDesc" placeholder="Enter Description">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnCreateChannel">Create</button>
            </div>
        </div>
    </div>
</div>

<!--simple popup for update channel -->
<div class="modal fade" id="updateChannelModal" tabindex="-1" role="dialog" aria-labelledby="updateChannelModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateChannelLabel">Update Channel</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="txtnewName">Channel Name</label>
                    <input type="text" class="form-control" id="txtnewName" placeholder="New Channel name">
                </div>
                <div class="form-group">
                    <label for="txtnewDesc">Description</label>
                    <input type="text" class="form-control" id="txtnewDesc" placeholder="Enter Description">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnUpdateChannel">Update</button>
            </div>
        </div>
    </div>
</div>

<!-- simple popup for get channel -->
<div class="modal fade" id="getChannelModal" tabindex="-1" role="dialog" aria-labelledby="getChannelModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="getChannelLabel">Channel details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modalbody">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Ok</button>
            </div>
        </div>
    </div>
</div>

<!-- Display Lists -->
<div>
    <h5>List of channels in the Team:</h5>
    <p id="channels"></p>

    <br/><br/>
    <h5>List of members:</h5>
    <p id="members"></p>
    <br/>
</div>

<script>
    var token = "{{ token | safe }}";

    $(document).ready(function () {
        if (typeof microsoftTeams === 'undefined') {
            console.error("Microsoft Teams SDK is not loaded!");
            return;
        }
        
        microsoftTeams.app.initialize().then(() => {
            microsoftTeams.app.getContext().then(function(context) {
                var teamId = context.team?.groupId || context.groupId || context.team?.id;

                if (teamId) {
                    getChannelsList(token, teamId);
                    getMembersList(token, teamId);
                } else {
                    console.warn("No team ID found in context - this might not be running in a Team");
                }
            }).catch(function(error) {
                console.error("Error getting initial context:", error);
            });
        }).catch(function(error) {
            console.error("Error initializing Teams SDK:", error);
        });

        function getChannelsList(accessToken, teamId) {
            $.ajax({
                url: "https://graph.microsoft.com/v1.0/teams/" + teamId + "/channels",
                type: "GET",
                beforeSend: function (request) {
                    request.setRequestHeader("Authorization", "Bearer " + accessToken);
                },
                success: function (profile) {
                    ListChannels(profile);
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.error("Error loading channels:", textStatus, errorThrown);
                },
            });
        }

        function getMembersList(accessToken, teamId) {
            $.ajax({
                url: "https://graph.microsoft.com/v1.0/teams/" + teamId + "/Members",
                type: "GET",
                beforeSend: function (request) {
                    request.setRequestHeader("Authorization", "Bearer " + accessToken);
                },
                success: function (profile) {
                    ListMembers(profile);
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.error("Error loading members:", textStatus, errorThrown);
                },
            });
        }

        $("#btnCreateChannel").on('click', function (e) {
            if (typeof microsoftTeams === 'undefined') {
                alert("Error: Microsoft Teams SDK is not loaded");
                return;
            }
            
            microsoftTeams.app.getContext().then(function (context) {
                var teamId = context.team?.groupId || context.groupId || context.team?.id;
                var cName = $("#txtchannelName").val();
                var cDesc = $("#txtchannelDesc").val();
                
                if (!teamId) {
                    alert("Error: No team ID found. Make sure this app is installed at the team level.");
                    return;
                }
                
                if (!cName || cName.trim() === '') {
                    alert("Please enter a channel name");
                    return;
                }
                
                if (!token) {
                    alert("Error: No authentication token available");
                    return;
                }
                
                e.preventDefault();
                $("#createChannelModal").modal('toggle');
                $('.modal-backdrop').removeClass('modal-backdrop');
                $('.fade').removeClass('fade');
                $('.in').removeClass('in');

                const payload = { displayName: cName, description: cDesc };

                $.ajax({
                    url: "https://graph.microsoft.com/v1.0/teams/" + teamId + "/channels",
                    type: "POST",
                    data: JSON.stringify(payload),
                    headers: {
                        Accept: 'application/json',
                        'Content-Type': 'application/json',
                    },
                    beforeSend: function (request) {
                        request.setRequestHeader("Authorization", "Bearer " + token);
                    },
                    success: function (data) {
                        alert("Channel created successfully!");
                        getChannelsList(token, teamId);
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        console.error("Error creating channel:", xhr.status, xhr.responseText);
                        
                        try {
                            var errorResponse = JSON.parse(xhr.responseText);
                            alert("Error creating channel: " + errorResponse.error.message);
                        } catch (e) {
                            alert("Error creating channel: " + xhr.status + " - " + textStatus);
                        }
                    },
                });
            }).catch(function(error) {
                console.error("Error getting Teams context:", error);
                alert("Error getting Teams context: " + error);
            });
        });

        $("#btnUpdateChannel").on('click', function (e) {
            microsoftTeams.app.getContext().then(function (context) {
                var teamId = context.team?.groupId || context.groupId;
                var channelId = context.channel?.id;
                var cName = $("#txtnewName").val();
                var cDesc = $("#txtnewDesc").val();
                
                if (!teamId) {
                    alert("Error: No team ID found");
                    return;
                }
                
                if (!channelId) {
                    alert("Error: No channel ID found. Make sure you're in a specific channel.");
                    return;
                }
                
                if (!cName || cName.trim() === '') {
                    alert("Please enter a new channel name");
                    return;
                }
                
                e.preventDefault();
                $("#updateChannelModal").modal('toggle');
                $('.modal-backdrop').removeClass('modal-backdrop');
                $('.fade').removeClass('fade');
                $('.in').removeClass('in');

                const payload = { displayName: cName, description: cDesc };

                $.ajax({
                    url: "https://graph.microsoft.com/v1.0/teams/" + teamId + "/channels/" + channelId,
                    type: "PATCH",
                    data: JSON.stringify(payload),
                    headers: {
                        Accept: 'application/json',
                        'Content-Type': 'application/json',
                    },
                    beforeSend: function (request) {
                        request.setRequestHeader("Authorization", "Bearer " + token);
                    },
                    success: function (profile) {
                        alert("Channel updated successfully!");
                        getChannelsList(token, teamId);
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        console.error("Error updating channel:", xhr.status, xhr.responseText);
                        
                        try {
                            var errorResponse = JSON.parse(xhr.responseText);
                            alert("Error updating channel: " + errorResponse.error.message);
                        } catch (e) {
                            alert("Error updating channel: " + xhr.status + " - " + textStatus);
                        }
                    },
                });
            }).catch(function(error) {
                console.error("Error getting Teams context for update:", error);
                alert("Error getting Teams context: " + error);
            });
        });

        $("#btngetChannel").on('click', function (e) {
            microsoftTeams.app.getContext().then(function (context) {
                var teamId = context.team?.groupId || context.groupId;
                var channelId = context.channel?.id;
                
                if (!teamId) {
                    alert("Error: No team ID found");
                    return;
                }
                
                if (!channelId) {
                    alert("Error: No channel ID found. Make sure you're in a specific channel.");
                    return;
                }
                
                e.preventDefault();

                $.ajax({
                    url: "https://graph.microsoft.com/v1.0/teams/" + teamId + "/channels/" + channelId,
                    type: "GET",
                    beforeSend: function (request) {
                        request.setRequestHeader("Authorization", "Bearer " + token);
                    },
                    success: function (response) {
                        $('#getChannelModal').modal('show');
                        $('#modalbody').html("Name: " + response["displayName"] + "<p>Description: " + (response["description"] || "No description"));
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        console.error("Error getting channel details:", xhr.status, xhr.responseText);
                        
                        try {
                            var errorResponse = JSON.parse(xhr.responseText);
                            alert("Error getting channel details: " + errorResponse.error.message);
                        } catch (e) {
                            alert("Error getting channel details: " + xhr.status + " - " + textStatus);
                        }
                    },
                });
            }).catch(function(error) {
                console.error("Error getting Teams context for get channel:", error);
                alert("Error getting Teams context: " + error);
            });
        });
    });

    function DeleteChannel() {
        if (!confirm("Are you sure you want to delete this channel? This action cannot be undone.")) {
            return;
        }
        
        microsoftTeams.app.getContext().then(function (context) {
            var teamId = context.team?.groupId || context.groupId;
            var channelId = context.channel?.id;
            
            if (!teamId) {
                alert("Error: No team ID found");
                return;
            }
            
            if (!channelId) {
                alert("Error: No channel ID found. Make sure you're in a specific channel.");
                return;
            }

            $.ajax({
                url: "https://graph.microsoft.com/v1.0/teams/" + teamId + "/channels/" + channelId,
                type: "DELETE",
                beforeSend: function (request) {
                    request.setRequestHeader("Authorization", "Bearer " + token);
                },
                success: function () {
                    alert("Channel deleted successfully!");
                    getChannelsList(token, teamId);
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.error("Error deleting channel:", xhr.status, xhr.responseText);
                    
                    try {
                        var errorResponse = JSON.parse(xhr.responseText);
                        alert("Error deleting channel: " + errorResponse.error.message);
                    } catch (e) {
                        alert("Error deleting channel: " + xhr.status + " - " + textStatus);
                    }
                },
            });
        }).catch(function(error) {
            console.error("Error getting Teams context for delete:", error);
            alert("Error getting Teams context: " + error);
        });
    }

    function ListChannels(profile) {
        var list = profile.value;
        var text = list.map(c => c.displayName).join("<br>");
        document.getElementById("channels").innerHTML = text;
    }

    function ListMembers(profile) {
        var list = profile.value;
        var text = list.map(m => m.displayName).join("<br>");
        document.getElementById("members").innerHTML = text;
    }
</script>
</body>
</html>
