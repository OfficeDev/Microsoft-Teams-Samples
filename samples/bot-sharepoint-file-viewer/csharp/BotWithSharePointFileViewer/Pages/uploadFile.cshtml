@page
@model BotWithSharePointFileViewer.Pages.uploadFileModel
@{
}

<head>
    <script src="https://res.cdn.office.net/teams-js/2.34.0/js/MicrosoftTeams.min.js"
            integrity="sha384-brW9AazbKR2dYw2DucGgWCCcmrm2oBFV4HQidyuyZRI/TnAkmOOnTARSTdps3Hwt"
            crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        microsoftTeams.app.initialize();

        microsoftTeams.app.getContext().then(async (context) => {
            console.log("context is " + JSON.stringify(context));
        });

        function submit() {
            const input = document.querySelector('input[type="file"]');
            const file = input.files[0];
            
            if (!file) {
                alert('Please select a file to upload');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);

            // Show loading state
            const button = document.querySelector('button');
            const originalText = button.innerText;
            button.innerText = 'Uploading...';
            button.disabled = true;

            $.ajax({
                url: '/upload',
                type: "POST",
                data: formData,
                contentType: false,
                cache: false,
                processData: false,
                success: function (response) {
                    console.log('Upload successful:', response);
                    microsoftTeams.dialog.url.submit(true);
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.log("Upload failed - Status:", xhr.status);
                    console.log("Response:", xhr.responseText);
                    console.log("textStatus: " + textStatus + ", errorThrown:" + errorThrown);
                    
                    let errorMessage = 'Upload failed';
                    if (xhr.responseText) {
                        try {
                            const errorResponse = JSON.parse(xhr.responseText);
                            errorMessage = errorResponse.message || errorResponse.title || xhr.responseText;
                        } catch (e) {
                            errorMessage = xhr.responseText;
                        }
                    }
                    
                    // Show specific error messages for common issues
                    if (xhr.status === 401) {
                        errorMessage = 'Authentication failed. Please try logging in again.';
                    } else if (xhr.status === 403) {
                        errorMessage = 'Access denied. Please check SharePoint permissions.';
                    } else if (xhr.status === 404) {
                        errorMessage = 'SharePoint site not found. Please check site configuration.';
                    }
                    
                    alert('Upload failed: ' + errorMessage);
                },
                complete: function() {
                    // Reset button state
                    button.innerText = originalText;
                    button.disabled = false;
                }
            });
        }
    </script>
</head>
<body class="theme-light">
    <div class="surface">
        <div class="panel">
            <div>
                <input type="file" name="file" id="file" accept=".docx, .pdf, .xlsx">
                <br/>
                <br/>
                <br/>
                <button type="button" onclick="submit()">Upload</button>
            </div>
        </div>
    </div>
</body>