<html>

<head>
</head>

<body>
   

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.1.1.js"
        integrity="sha384-VC7EHu0lDzZyFfmjTPJq+DFyIn8TUGAJbEtpXquazFVr00Q/OOx//RjiZ9yU9+9m"
        crossorigin="anonymous"></script>
    <script src="https://res.cdn.office.net/teams-js/2.0.0/js/MicrosoftTeams.min.js" crossorigin="anonymous"></script>
    <script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.17/js/adal.min.js"
        integrity="sha384-BIOS/65fbAsb2XiCCSTlZSTTl0ZgqkOU522dpyk5meOnN2EOQ3uH+QpqEtoAtmBn"
        crossorigin="anonymous"></script>


      <!-- Login button -->
    <p>Link your account with Microsoft to stay logged in always!</p>
    <button id="linkEntraAccount">Link Entra Account</button>
    <button onclick="closeTaskModule()">Skip</button>

             <script src="../public/entra-bundle.js"></script>       

      

    <script type="text/javascript">
                let primaryAccResult, secondaryAccResult;
        
        microsoftTeams.app.initialize().then(() => {
        });

        
        function closeTaskModule() {
            microsoftTeams.tasks.submitTask();
        }

        function loginAuth0() {
            microsoftTeams.authentication.authenticate({
            url: `https://dev-zvtwcdg4lg5a82cq.us.auth0.com/authorize?audience=https://dev-zvtwcdg4lg5a82cq.us.auth0.com/api/v2/&response_type=code&scope=update:current_user_identities%20openid%20profile%20email&client_id=4Ccf0XImjVVt96wKX3mUllgWaVUh2qxB&redirect_uri=https://teams-auth.ngrok.io/Auth0Success&state=${(new Date()).getTime()%1000}`,
            width: 600,
            height: 535,
            successCallback: (result) => {
                console.log("notify success ", JSON.parse(result));
                try {
                    primaryAccResult = JSON.parse(result);
                     console.log({primaryAccResult});
                    } catch {
                    console.log("error");
                }
                    
                    microsoftTeams.authentication.authenticate({
            url: `https://dev-zvtwcdg4lg5a82cq.us.auth0.com/authorize?connection=Microsoftentracustom&audience=https://dev-zvtwcdg4lg5a82cq.us.auth0.com/api/v2/&response_type=code&scope=update:current_user_identities%20openid%20profile%20email&client_id=4Ccf0XImjVVt96wKX3mUllgWaVUh2qxB&redirect_uri=https://teams-auth.ngrok.io/Auth0Success&state=${(new Date()).getTime()%1000}`,
            width: 600,
            height: 535,
            successCallback: (result) => {
                console.log("notify success ", JSON.parse(result));
                try {
                    secondaryAccResult = JSON.parse(result);
                    console.log({secondaryAccResult});
                    
                    var linkOptions = {
                        method: 'POST',
                        url: `https://dev-zvtwcdg4lg5a82cq.us.auth0.com/api/v2/users/${primaryAccResult.userResponse.data.sub}/identities`,
                        headers: {authorization: `Bearer ${primaryAccResult.response.data.access_token}`},
                        data:  {
                                                    
                            // "provider": "oauth2",
                            // "user_id": "Microsoftentracustom|af53eca6-db6f-4085-8436-b9d2cb446ea3"
    
                            "link_with": secondaryAccResult.response.data.id_token
                        }
                        
                        };
            axios.request(linkOptions).then(function (response) {
                console.log({response});
            }).catch((err) => {
                console.log('link error', err);
            });
                } catch(err) {
                    console.log("secondary auth successcallback error", err);
                }
            },
            failureCallback: (reason) => {
                console.log("secondary failure", reason);
            },
            });
                
            },
            failureCallback: (reason) => {
                console.log("primary failure", reason);
            },
            });
                    
                }

                function auth0logout() {
                    const logoutUrl = `https://dev-zvtwcdg4lg5a82cq.us.auth0.com/v2/logout?client_id=4Ccf0XImjVVt96wKX3mUllgWaVUh2qxB&returnTo=https://teams-auth.ngrok.io/Auth0Success`;

                    window.location.href = logoutUrl;

                    }
       
            $("#" + errorDivId).text(reason).show();
            $("#divProfile").hide();
        }
    </script>
</body>
</html>